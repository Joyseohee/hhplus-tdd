# 💳 hhplus-tdd - 포인트 관리 시스템

## 📝 프로젝트 개요

사용자별 포인트 시스템을 구현한 백엔드 서비스로, `충전`, `사용`, `조회`, `내역 조회`의 4가지 기능을 제공합니다.  
DB를 사용하지 않고 주어진 `InMemory Table` 기반으로 상태를 유지하며, 테스트 주도 개발(TDD) 방식으로 설계 및 구현되었습니다.

---

## 🎯 개발 목표 및 의도

- **객체 간 책임과 역할의 명확한 분리**  
  `Controller`, `Service`, `Domain` 계층이 각자의 역할에 충실하도록 구조화했습니다.

- **테스트 가능하고 신뢰할 수 있는 구조**  
  Spring Context 없이도 테스트 가능하며, 도메인, 서비스, API 레벨에서 각각 테스트를 수행할 수 있도록 설계했습니다.
  서비스 레이어에 통합테스트를 일부 추가해 데이터 반영 및 예외 발생 시 상태가 롤백되어 트랜잭션이 정상적으로 적용되고 있음을 확인하습니다.

- **과도한 설계 배제 (Anti-Overengineering)**  
  단순한 기능 요구사항에 맞춰 꼭 필요한 객체만 정의하고, 적절한 책임만을 부여했습니다.

---

## 🧱 주요 구성

### 도메인 객체

| 객체         | 책임 및 설명 |
|--------------|--------------|
| `UserPoint`  | 포인트 잔고를 관리하고, 충전/사용 정책 검증을 포함하는 핵심 도메인 객체 |
| `PointHistory` | 충전/사용 내역을 기록하는 불변 객체 |

- 도메인 객체는 외부에서 직접 생성할 수 없습니다.  
  오직 `create` 등의 **비즈니스 메소드**를 통해서만 생성 및 상태 변경이 가능합니다.

---

## ⚖️ 도메인 정책

| 정책 항목 | 설명 |
|-----------|------|
| **최대 잔고** | 500,000 포인트를 초과할 수 없음 |
| **최소 거래 금액** | 1원 이상이어야 충전 또는 사용 가능 |
| **잔고 부족 불가** | 현재 포인트보다 큰 금액은 사용할 수 없음 |


### 💡 실제 금융 규제 반영

본 과제의 포인트 시스템은 **선불전자지급수단**과 유사한 것으로 간주하며,  
전자금융거래법 시행령 제13조에 따라 **무기명식 보유 한도인 50만 원**을 최대 잔고로 설정했습니다.

- 🔒 **최대 잔고: 500,000 포인트**
- 🔑 정책은 도메인 계층에 정의되며, 정책 위반 시 예외를 발생시킵니다.

---

## 💥 예외 처리 전략

- 예외는 반드시 **해당 정책/로직의 책임을 가진 객체나 메소드에서 발생**합니다.  
  → 재사용 시에도 일관된 규칙 적용을 보장

- 예외는 다음 기준에 따라 구분합니다:

| 예외 유형 | 설명 | 계층 |
|-----------|------|------|
| `IllegalArgumentException` | 도메인 정책 위반 (e.g. 최소 금액, 최대 잔고 초과) | Domain |
| `RuntimeException` 계열 커스텀 예외 | 비즈니스 실패 (e.g. 유저 없음, 롤백 실패 등) | Service |

- 요구사항이 단순하고 예외 종류가 많지 않기 때문에 예외 메시지와 코드 분리 없이 객체 내부에서 직접 정의했습니다.

### 📌 예외 처리 예시

| 예외 유형                  | 설명 |
|------------------------|------|
| `USER_NOT_FOUND`       | 존재하지 않는 유저에 대한 요청 |
| `INVALID_AMOUNT`       | 최소 거래 금액 미만 충전/사용 |
| `BALANCE_EXCEEDED`     | 최대 잔고 초과 |
| `INSUFFICIENT_BALANCE` | 잔고 부족 |
| `POINT_TXN_FAILED`     | 히스토리 기록 실패 등 비즈니스 예외 |

→ 예외는 `ApiControllerAdvice`를 통해 `ErrorResponse(code: String, message: String)` 형식으로 변환되어 응답됩니다.

---

## 🧪 테스트 전략

### 단위 테스트
- `UserPoint`: 상태 변화 및 정책 위반 검증
- `PointService`: 정상 흐름, 예외 흐름 모두 검증
- `PointController`: API 요청/응답에 대한 MockMvc 기반 테스트

단위 테스트는 
1. 상태나 행위 검증, 
2. 혹은 역할과 책임 검증
3. 비즈니스 로직이 요구사항대로 동작하고 있는지 확인이 필요한 객체에 대해서만 작성했습니다.

PointHistory는 상태 변화가 없고 동반된 정책 또한 없으므로 단위 테스트는 생략했습니다.

### 경량 통합 테스트 (Spring Context 없이도 가능)
- 실제 `UserPointTable`, `PointHistoryTable`과 `PointService` 조합
- 데이터 반영 및 예외 발생 시 상태 일관성 확인

---

## ✂️ 과제 템플릿 변경 사항 및 유지 이유

- **템플릿 구조는 유지하되, 다음만 수정**:

| 항목 | 수정 이유                                                                                              |
|------|----------------------------------------------------------------------------------------------------|
| Controller path/요청 형식 | 구조가 단순하고 검증할 데이터가 많지 않아 주요한 로직 테스트에 집중하기 위해 DTO로 수정하지 않음                                           |
| Response 객체 | 역할이 명확하고 API 수가 적어 변경하지 않음, 프로젝트의 규모가 커진다면 Reponse 객체를 고도화할 필요성이 있음. ErrorResponse와 예외 처리 역시 마찬가지. |
| 도메인 생성자 `private` 변경 | 외부에서 직접 객체 생성 방지. 책임 있는 메소드 통해서만 생성 가능                                                             |
| 도메인 객체 상태 검증 정책 강화 | 무결성 보장 및 예외 명확화                                                                                    |
| Table 클래스는 수정하지 않음 | 명시된 조건에 따라 외부 구현체는 건드리지 않음                                                                         |

---

## 📦 기술 스택

- Kotlin 1.9
- JDK 17
- Spring Boot 3 +
- JUnit5, Mockk, Kotest
- Gradle

---

## 📎 API 예시

### ✅ 충전 성공

```http
PATCH /point/1/charge
Body: 10000
````

```json
{
  "id": 1,
  "point": 10000,
  "updateMillis": 1720797823371
}
```

### ❌ 잔고 초과

```json
{
  "code": "400",
  "message": "최대 잔고 한도를 초과할 수 없습니다."
}
```

---

## 📚 마무리

이 프로젝트는 TDD와 객체지향 원칙을 중심으로, 단순한 요구사항을 어떻게 명확하게 구조화할 수 있는지를 보여주는 예제입니다.
특히 **객체 간 책임과 역할의 명확한 분리**, **정책 중심의 도메인 설계**, **예외 처리 등 전략의 단순화**, **불필요한 계층 및 객체 분리 배제**라는 세 가지 중심 원칙을 유지하면서,
**테스트 가능하고 확장 가능한 구조**를 만드는 데 초점을 맞추었습니다.
